<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>Bibliobus · Detalle de libro</title>
    <link rel="stylesheet" href="/static/styles.css" />
  </head>
  <body class="page">
    <header class="topbar">
      <div class="brand">Bibliobus</div>
      <nav class="nav-links">
        <a href="/catalog">Catálogo</a>
        <a href="/dashboard">Dashboard</a>
        <a href="/recommendations">Recomendaciones</a>
        <a href="/ratings">Valorar</a>
      </nav>
    </header>

    <main>
      <section id="detalle">
        <div class="section-heading">
          <h2>Detalle de libro</h2>
          <a href="/catalog" class="btn-secondary" style="text-decoration:none;">Volver al catálogo</a>
        </div>
        <div id="book-detail" class="detail-panel muted">Cargando...</div>
      </section>
    </main>

    <script>
      const FALLBACK_COVER = "/static/placeholder.svg";
      const params = new URLSearchParams(window.location.search);
      const bookId = params.get("id");

      if (!bookId) {
        document.getElementById("book-detail").textContent = "No se indicó ningún libro.";
      } else {
        loadBookDetail(bookId);
      }

      function escapeHtml(text) {
        return text
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }

      function formatComment(text) {
        return escapeHtml(text).replace(/\n/g, "<br />");
      }

      async function fetchJson(url) {
        const response = await fetch(url);
        if (!response.ok) throw new Error("Error al consultar " + url);
        return response.json();
      }

      async function loadBookDetail(id) {
        const container = document.getElementById("book-detail");
        container.innerHTML = "<span class='muted'>Cargando detalle...</span>";
        try {
          const [book, ratings] = await Promise.all([
            fetchJson(`/api/books/${id}`),
            fetchJson(`/api/ratings?book_id=${id}`),
          ]);
          const ratingCount = ratings.length;
          const avg = ratingCount ? (ratings.reduce((acc, r) => acc + r.rating, 0) / ratingCount).toFixed(2) : null;
          const commentsList = ratingCount
            ? ratings
                .map((r) => {
                  const humanComment = r.comment
                    ? `<p class="comment-text">${formatComment(r.comment)}</p>`
                    : "<p class='comment-text muted'>Sin comentario.</p>";
                  return `<li><div class="comment-rating">Puntuaci&oacute;n: ${r.rating}/5</div>${humanComment}</li>`;
                })
                .join("")
            : "<li>No hay valoraciones registradas.</li>";
          container.innerHTML = `
            <img src="${book.image_url || FALLBACK_COVER}" alt="Portada" onerror="this.src='${FALLBACK_COVER}'; this.onerror=null;" />
            <h3>${book.title}</h3>
            <p class="muted">${book.author || ""}</p>
            <p>Idioma: ${book.language || "N/D"} &middot; A&ntilde;o: ${book.published_year || "N/D"}</p>
            <p>Puntuaci&oacute;n media: ${avg ? `${avg} (${ratingCount} votos)` : "Sin valoraciones"}</p>
            <h4>Comentarios</h4>
            <ul class="comment-list">${commentsList}</ul>
          `;
        } catch (error) {
          console.error(error);
          container.innerHTML = "<span class='muted'>Error al cargar el detalle.</span>";
        }
      }
    </script>
  </body>
</html>
