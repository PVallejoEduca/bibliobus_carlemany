<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>Bibliobus · Detalle de libro</title>
    <link rel="stylesheet" href="/static/styles.css" />
  </head>
  <body class="page">
    <header class="topbar">
      <div class="brand">Bibliobus</div>
      <nav class="nav-links">
        <a href="/catalog">Catálogo</a>
        <a href="/dashboard">Dashboard</a>
        <a href="/recommendations">Recomendaciones</a>
        <a href="/ratings" data-auth-required>Valorar</a>
        <a href="/profile" class="nav-avatar hidden" data-profile-link title="Perfil">
          <span class="avatar-icon"></span>
        </a>
        <button type="button" class="btn-secondary nav-logout hidden" data-logout>Salir</button>
        <a href="/login" data-login-link>Login</a>
      </nav>
    </header>

    <main>
      <section id="detalle">
        <div class="section-heading">
          <h2>Detalle de libro</h2>
          <a href="/catalog" class="btn-secondary" style="text-decoration:none;">Volver al catálogo</a>
        </div>
        <div id="book-detail" class="detail-panel muted">Cargando...</div>
      </section>
    </main>

    <script src="/static/app.js"></script>
    <script>
      const FALLBACK_COVER = "/static/placeholder.svg";
      const params = new URLSearchParams(window.location.search);
      const bookId = params.get("id");

      if (!bookId) {
        document.getElementById("book-detail").textContent = "No se indicó ningún libro.";
      } else {
        loadBookDetail(bookId);
      }

      function escapeHtml(text) {
        return text
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }

      function formatComment(text) {
        return escapeHtml(text).replace(/\n/g, "<br />");
      }

      async function fetchJson(url) {
        const response = await fetch(url);
        if (!response.ok) throw new Error("Error al consultar " + url);
        return response.json();
      }

      async function loadBookDetail(id) {
        const container = document.getElementById("book-detail");
        container.innerHTML = "<span class='muted'>Cargando detalle...</span>";
        try {
          const [book, ratings] = await Promise.all([
            fetchJson(`/api/books/${id}`),
            fetchJson(`/api/ratings?book_id=${id}`),
          ]);
          const ratingCount = ratings.length;
          const avg = ratingCount ? (ratings.reduce((acc, r) => acc + r.rating, 0) / ratingCount).toFixed(2) : null;
          const commentsList = ratingCount
            ? ratings
                .map((r) => {
                  const humanComment = r.comment
                    ? `<p class="comment-text">${formatComment(r.comment)}</p>`
                    : "<p class='comment-text muted'>Sin comentario.</p>";
                  return `<article class="comment-card"><div class="comment-header">Puntuaci&oacute;n <strong>${r.rating}/5</strong></div>${humanComment}</article>`;
                })
                .join("")
            : "<p class='muted'>No hay valoraciones registradas.</p>";
          container.innerHTML = `
            <div class="book-hero">
              <div class="book-cover">
                <img src="${book.image_url || FALLBACK_COVER}" alt="Portada" onerror="this.src='${FALLBACK_COVER}'; this.onerror=null;" />
              </div>
              <div class="book-info">
                <h3>${book.title}</h3>
                <p class="muted">${book.author || "Autor desconocido"}</p>
                <div class="book-tags">
                  <span class="tag">${book.language || "Idioma N/D"}</span>
                  <span class="tag">${book.published_year || "Año N/D"}</span>
                </div>
                <dl class="book-stats">
                  <div>
                    <dt>Puntuaci&oacute;n media</dt>
                    <dd>${avg ? `${avg}/5` : "Sin datos"}</dd>
                  </div>
                  <div>
                    <dt>Valoraciones</dt>
                    <dd>${ratingCount}</dd>
                  </div>
                  <div>
                    <dt>ID libro</dt>
                    <dd>#${book.book_id}</dd>
                  </div>
                </dl>
                <p class="book-description">
                  Idioma: ${book.language || "N/D"} &middot; A&ntilde;o: ${book.published_year || "N/D"}
                </p>
              </div>
            </div>
            <div class="comments-section">
              <div class="section-heading">
                <h4>Comentarios</h4>
                <span class="muted">${ratingCount ? `${ratingCount} valoraciones` : ""}</span>
              </div>
              <div class="comment-list">${commentsList}</div>
            </div>
          `;
        } catch (error) {
          console.error(error);
          container.innerHTML = "<span class='muted'>Error al cargar el detalle.</span>";
        }
      }
    </script>
  </body>
</html>
