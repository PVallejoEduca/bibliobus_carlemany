<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>Bibliobus Â· Dashboard</title>
    <link rel="stylesheet" href="/static/styles.css" />
  </head>
  <body class="page">
    <header class="topbar">
      <div class="brand">Bibliobus</div>
      <nav class="nav-links">
        <a href="/catalog">CatÃ¡logo</a>
        <a href="/dashboard" class="active">Dashboard</a>
        <a href="/recommendations">Recomendaciones</a>
        <a href="/ratings" data-auth-required>Valorar</a>
        <a href="/profile" class="nav-avatar hidden" data-profile-link title="Perfil">
          <span class="avatar-icon"></span>
        </a>
        <button type="button" class="btn-secondary nav-logout hidden" data-logout>Salir</button>
        <a href="/login" data-login-link>Login</a>
      </nav>
    </header>

    <main>
      <section class="kpi-section">
        <div class="section-heading">
          <h2>Resumen de la biblioteca</h2>
          <button id="refresh-kpis" class="btn-secondary">Actualizar</button>
        </div>
        <div id="kpi-grid" class="kpi-grid"></div>
        <div id="kpi-status" class="muted"></div>
      </section>

      <section class="kpi-section">
        <div class="section-heading">
          <h2>Indicadores simulados</h2>
          <span class="muted">Valores inventados para completar la demo.</span>
        </div>
        <div id="placeholder-grid" class="kpi-grid"></div>
      </section>
    </main>

    <script src="/static/app.js"></script>
    <script>
      const KPI_CARDS = [
        { key: "books", label: "Libros disponibles", icon: "ðŸ“š", accent: "#3b82f6" },
        { key: "copies", label: "Ejemplares totales", icon: "ðŸ“¦", accent: "#22d3ee" },
        { key: "users", label: "Usuarios registrados", icon: "ðŸ‘¥", accent: "#f472b6" },
        { key: "ratings", label: "Valoraciones registradas", icon: "â­", accent: "#facc15" },
        { key: "avg_copies_per_book", label: "Ejemplares por libro", icon: "ðŸ“Š", accent: "#a78bfa" },
        { key: "avg_ratings_per_user", label: "Valoraciones por usuario", icon: "ðŸ§‘â€ðŸ’»", accent: "#f87171" },
        {
          key: "avgRatings",
          label: "Valoraciones por libro",
          icon: "ðŸ“ˆ",
          accent: "#34d399",
          compute: (kpis) =>
            kpis.avg_ratings_per_book ?? (kpis.books ? (kpis.ratings / kpis.books).toFixed(2) : "0"),
        },
        {
          key: "activity",
          label: "Ejemplares sin libro / Valoraciones sin ejemplar",
          icon: "ðŸ› ï¸",
          accent: "#f97316",
          compute: (kpis) => `${kpis.orphan_copies || 0} / ${kpis.orphan_ratings || 0}`,
        },
      ];

      const PLACEHOLDER_DATA = [
        {
          icon: "âš ï¸",
          title: "Usuarios con strikes",
          value: "3",
          note: "Dato inventado para la demo",
        },
        {
          icon: "ðŸ“",
          title: "Valoraciones en moderaciÃ³n",
          value: "7",
          note: "Dato inventado para la demo",
        },
        {
          icon: "ðŸ“…",
          title: "Eventos programados del bibliobÃºs",
          value: "12",
          note: "Indica prÃ³ximas paradas, pendiente implementar",
        },
        {
          icon: "ðŸ“¨",
          title: "Solicitudes de prÃ©stamo",
          value: "24",
          note: "Solicitudes web aÃºn no conectadas",
        },
        {
          icon: "ðŸ’¬",
          title: "Mensajes de contacto sin leer",
          value: "5",
          note: "MÃ³dulo de soporte en desarrollo",
        },
        {
          icon: "â­",
          title: "Libros destacados por comunidad",
          value: "8",
          note: "Basado en un ranking futuro",
        },
      ];

      function formatNumber(value) {
        const number = Number(value);
        if (Number.isNaN(number)) {
          return value;
        }
        return number.toLocaleString("es-ES");
      }

      async function fetchJson(url) {
        const response = await fetch(url);
        if (!response.ok) throw new Error("Error al consultar " + url);
        return response.json();
      }

      function renderCards(kpis) {
        const grid = document.getElementById("kpi-grid");
        grid.innerHTML = "";
        KPI_CARDS.forEach((card) => {
          const value = card.compute ? card.compute(kpis) : kpis[card.key] ?? 0;
          const article = document.createElement("article");
          article.className = "kpi-card";
          article.style.setProperty("--accent-color", card.accent);
          article.innerHTML = `
            <div class="kpi-icon">${card.icon}</div>
            <div class="kpi-value">${formatNumber(value)}</div>
            <div class="kpi-label">${card.label}</div>
          `;
          grid.appendChild(article);
        });
      }

      function renderPlaceholderCards() {
        const grid = document.getElementById("placeholder-grid");
        grid.innerHTML = "";
        PLACEHOLDER_DATA.forEach((item) => {
          const article = document.createElement("article");
          article.className = "kpi-card";
          article.style.setProperty("--accent-color", "#cbd5f5");
          article.innerHTML = `
            <div class="kpi-icon">${item.icon}</div>
            <div class="kpi-value">${item.value}</div>
            <div class="kpi-label">${item.title}</div>
            <small class="muted">${item.note}</small>
          `;
          grid.appendChild(article);
        });
      }

      async function loadKpis() {
        const status = document.getElementById("kpi-status");
        const grid = document.getElementById("kpi-grid");
        status.textContent = "Cargando indicadores...";
        grid.innerHTML = "";
        try {
          const kpis = await fetchJson("/api/kpis");
          renderCards(kpis);
          status.textContent = "Actualizado ahora mismo.";
        } catch (error) {
          console.error(error);
          status.textContent = "No se pudieron obtener los KPIs.";
        }
      }

      document.getElementById("refresh-kpis").addEventListener("click", loadKpis);
      loadKpis();
      renderPlaceholderCards();
    </script>
  </body>
</html>
